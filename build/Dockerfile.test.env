FROM golang:1.17.6 as builder

ARG REPO
WORKDIR /go/src/${REPO}

ENV K8S_VERSION=1.22.1
ENV ACK_GINKGO_DEPRECATIONS=1.16.5
# download the kubebuilder test binaries (kubebuilder, kube-apiserver, etcd, kubectl)
RUN os=$(go env GOOS) && \
	arch=$(go env GOARCH) && \
	mkdir -p /go/bin/kubebuilder/bin/ && \
	curl -LO https://github.com/kubernetes-sigs/kubebuilder/releases/download/v3.2.0/kubebuilder_${os}_${arch} && \
    curl -sSLo envtest-bins.tar.gz "https://go.kubebuilder.io/test-tools/${K8S_VERSION}/$(go env GOOS)/$(go env GOARCH)" ; \
    mv kubebuilder_${os}_${arch} /go/bin/kubebuilder/bin/ && \
    tar -C /go/bin/kubebuilder --strip-components=1 -zvxf envtest-bins.tar.gz

ARG KUBEBUILDER_ASSETS=/go/bin/kubebuilder/bin

# Copy the Go Modules manifests
COPY go.mod go.mod
COPY go.sum go.sum

# Copy the go source
COPY . .

RUN go test -cover -v ./...
